{% extends "base.html" %}
{% block title %}Player Details{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Coluna de Imagem -->
    <div class="col-md-4">
      {% set image_url = "https://api.efootballdb.com/assets/2022/players/" ~ player.konamiid ~ "_.png.webp" %}
      {% if player.pfifaid %}
        {% set pfifaid_str = player.pfifaid|string %}
        {% set padded = pfifaid_str.zfill(6) %}
        {% set dir1 = padded[:3] %}
        {% set dir2 = padded[3:] %}
        {% set image_url = "https://cdn.sofifa.net/players/" ~ dir1 ~ "/" ~ dir2 ~ "/25_360.png" %}
      {% endif %}
      
      <img src="{{ image_url }}" alt="{{ player.playername }}" style="max-height: 160px;" class="float-left mr-3">
    </div>
    <!-- Coluna de Dados Básicos -->
    <div class="col-md-8">
      <h1>{{ player.playername or '-' }}</h1>
      <p>
        <strong>PES ID:</strong> {{ player.konamiid }}<br>
        <strong>Nationality:</strong> {{ player.nationality1 or '-' }}<br>
        <strong>Age:</strong> {{ player.age or '-' }}{% if player.birthdate %} ({{ player.birthdate }}){% endif %}<br>
        <strong>Height:</strong> {{ player.height or '-' }} cm / <strong>Weight:</strong> {{ player.weight or '-' }} kg<br>
        <strong>Strong Foot:</strong>
          {% set foot = (player.strongfoot|string)|trim|lower %}
          {{ "Right" if foot == "0" or foot == "right" else "Left" }} foot<br>
        {% if player.pfifaid %}
          <strong>FIFA ID:</strong> {{ player.pfifaid }} (<a href="https://sofifa.com/player/{{ player.pfifaid }}" target="_blank">SoFIFA</a>)<br>
        {% endif %}
        {% if player.pbesoccerlink %}
          <strong>BeSoccer Link:</strong> <a href="{{ player.pbesoccerlink }}" target="_blank">{{ player.pbesoccerlink }}</a>
        {% endif %}
      </p>
    </div>
  </div>
  
  <hr>
  <!-- Abas -->
  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="basic-info-tab" data-toggle="pill" href="#basic-info" role="tab">Basic</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pills-stats-tab" data-toggle="pill" href="#pills-stats" role="tab">Stats</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pills-skills-tab" data-toggle="pill" href="#pills-skills" role="tab">Playing Style & Skills</a>
    </li>
  </ul>
  
  <div class="tab-content" id="pills-tabContent">
    <!-- Aba Basic Info -->
    <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
      <p>
        <strong>Player Name:</strong> {{ player.playername or '-' }}<br>
        <strong>Full Name:</strong> {{ player.fullname or '-' }}<br>
        <strong>Shirt Name:</strong> {{ player.clubshirtname or '-' }}<br>
        <strong>NT Shirt Name:</strong> {{ player.nationalshirtname or '-' }}<br>
      </p>
    </div>
    
    <!-- Aba Stats -->
    <div class="tab-pane fade" id="pills-stats" role="tabpanel">
      {% if player.overall is not none %}
        <p><strong>Overall Rating:</strong> {{ player.overall }}</p>
      {% endif %}
      {% if stats %}
        {% set desired_order = [
          "Offensive Awareness", "Ball Control", "Dribbling", "Tight Possession",
          "Low Pass", "Lofted Pass", "Finishing", "Heading", "Set Piece Taking",
          "Curl", "Speed", "Acceleration", "Kicking Power", "Jumping",
          "Physical Contact", "Balance", "Stamina", "Defensive Awareness", "Tackling",
          "Aggression", "Defensive Engagement", "GK Awareness", "GK Catching",
          "GK Parrying", "GK Reflexes", "GK Reach", "Weak Foot Usage",
          "Weak Foot Accuracy", "Form", "Injury Resistance"
        ] %}
        {% for key in desired_order %}
          <strong>{{ key }}:</strong> {{ stats.get(key, '-') }}<br>
        {% endfor %}
      {% else %}
        <p>No statistics available.</p>
      {% endif %}
    </div>

    
    <!-- Aba Playing Style & Skills -->
    <div class="tab-pane fade" id="pills-skills" role="tabpanel">
      {% if player.skills %}
      {# Verifica se player.skills é uma string e converte se necessário #}
      {% if player.skills is string %}
        {% set skills_data = player.skills | fromjson %}
      {% else %}
        {% set skills_data = player.skills %}
      {% endif %}
      
      {# AI Playing Styles #}
      {% set desired_styles_order = ["P01", "P02", "P03", "P04", "P05", "P06", "P07"] %}
      {% set style_labels = {
          "P01": "Trickster",
          "P02": "Mazing Run",
          "P03": "Speeding Bullet",
          "P04": "Incisive Run",
          "P05": "Long Ball Expert",
          "P06": "Early Cross",
          "P07": "Long Ranger"
      } %}

      {# Player Skills #}
      {% set desired_skill_order = [
          "S01", "S02", "S03", "S04", "S05", "S06", "S07", "S08", "S09", "S10",
          "S11", "S12", "S13", "S14", "S15", "S16", "S17", "S18", "S19", "S20",
          "S21", "S22", "S23", "S24", "S25", "S26", "S27", "S28", "S29", "S30",
          "S31", "S32", "S33", "S34", "S35", "S36", "S37", "S38", "S39", "S40",
          "S41", "S42", "S43", "S44", "S45", "S46", "S47", "S48", "S49", "S50"
      ] %}
      {% set skill_labels = {
          "S01": "Scissors Feint",
          "S02": "Double Touch",
          "S03": "Flip Flap",
          "S04": "Marseille Turn",
          "S05": "Sombrero",
          "S06": "Chop Turn",
          "S07": "Cut Behind & Turn",
          "S08": "Scotch Move",
          "S09": "Sole Control",
          "S10": "Momentum Dribbling",
          "S11": "Heading",
          "S12": "Long-Range Curler",
          "S13": "Chip Shot Control",
          "S14": "Knuckle Shot",
          "S15": "Dipping Shot",
          "S16": "Rising Shot",
          "S17": "Long Range Shooting",
          "S18": "Acrobatic Finishing",
          "S19": "Heel Trick",
          "S20": "First-time Shot",
          "S21": "Phenomenal Finishing",
          "S22": "One-touch Pass",
          "S23": "Through Passing",
          "S24": "Weighted Pass",
          "S25": "Pinpoint Crossing",
          "S26": "Edged Crossing",
          "S27": "Outside Curler",
          "S28": "Rabona",
          "S29": "No Look Pass",
          "S30": "Game-changing Pass",
          "S31": "Visionary Pass",
          "S32": "Low Lofted Pass",
          "S33": "GK Low Punt",
          "S34": "GK High Punt",
          "S35": "Long Throw",
          "S36": "GK Long Throw",
          "S37": "Penalty Specialist",
          "S38": "GK Penalty Saver",
          "S39": "Gamesmanship",
          "S40": "Man Marking",
          "S41": "Track Back",
          "S42": "Interception",
          "S43": "Blocker",
          "S44": "Aerial Superiority",
          "S45": "Sliding Tackle",
          "S46": "Fortress",
          "S47": "Acrobatic Clearance",
          "S48": "Captaincy",
          "S49": "Super-sub",
          "S50": "Fighting Spirit"
      } %}

      {% set skills_found = false %}
      <strong>Player Skills:</strong><br>
      {% for key in desired_skill_order %}
        {% if skills_data.get(key) in ["Yes", "1"] and skill_labels.get(key) %}
          {{ skill_labels[key] }}<br>
          {% set skills_found = true %}
        {% endif %}
      {% endfor %}
      {% if not skills_found == false %}
        <p>No player skills assigned for this player.</p>
      {% endif %}<br>

      {% set ns = namespace(styles_found=false) %}
      <strong>Player AI Playing Styles:</strong><br>
      {% for key in desired_styles_order %}
        {% if skills_data.get(key) in ["Yes", "1"] and style_labels.get(key) %}
          {{ style_labels[key] }}<br>
          {% set ns.styles_found = true %}
        {% endif %}
      {% endfor %}
      {% if not ns.styles_found %}
        <p>No playing styles assigned for this player.</p>
      {% endif %}

      {% else %}
        <p>Skills not available for this player.</p>
      {% endif %}
    </div>
    
  </div>
  
  <a href="/players" class="btn btn-secondary mt-3">Back to List</a>
</div>
{% endblock %}
